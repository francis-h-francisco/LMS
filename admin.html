<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Admin Panel - Course Builder</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .admin-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .stat-card {
            background: var(--bg-color);
            padding: 1.5rem;
            border-radius: 6px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table th {
            background: var(--bg-color);
            font-weight: 600;
        }
        .no-data {
            text-align: center;
            color: var(--text-color);
            opacity: 0.7;
            padding: 2rem;
        }
        .course-item {
            padding: 1rem;
            border: 1px solid var(--border-color);
            margin: 0.5rem 0;
            border-radius: 4px;
            background: var(--bg-color);
        }
        .course-item strong {
            display: block;
            margin-bottom: 0.5rem;
        }
        .course-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        /* Course Builder Styles */
        .builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .builder-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1.5rem;
        }
        @media (max-width: 992px) {
            .builder-container {
                grid-template-columns: 1fr;
            }
        }
        .builder-sidebar {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 1.5rem;
            height: fit-content;
            border: 1px solid var(--border-color);
        }
        .builder-preview {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 2rem;
        }
        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .form-section h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .form-section h3::before {
            content: "▶";
            font-size: 0.8rem;
            color: var(--primary-color);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        .form-group input, 
        .form-group textarea, 
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus, 
        .form-group textarea:focus, 
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .content-item {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.2s;
        }
        .content-item:hover {
            box-shadow: var(--shadow-sm);
        }
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            gap: 0.5rem;
        }
        .content-header select {
            flex: 1;
            margin-bottom: 0;
        }
        .content-actions {
            display: flex;
            gap: 0.25rem;
        }
        .content-actions button {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            transition: all 0.2s;
        }
        .content-actions button:hover {
            background: var(--bg-color);
            border-color: var(--primary-color);
        }
        .content-actions button.delete {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }
        .content-actions button.delete:hover {
            background: var(--danger-color);
            color: white;
        }
        .module-item, .lesson-item {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.2s;
        }
        .module-item:hover, .lesson-item:hover {
            box-shadow: var(--shadow-sm);
        }
        .module-header, .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        .module-header .form-group, .lesson-header .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .lesson-content {
            margin-left: 0.5rem;
            border-left: 2px solid var(--border-color);
            padding-left: 1rem;
        }
        .quiz-question-item {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: box-shadow 0.2s;
        }
        .quiz-question-item:hover {
            box-shadow: var(--shadow-sm);
        }
        .option-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }
        .option-row input[type="radio"] {
            width: auto;
            margin: 0;
        }
        .option-row input[type="text"] {
            flex: 1;
            margin-bottom: 0;
        }
        .option-row .delete-option {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preview-course {
            max-height: 600px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-color);
            border-radius: 4px;
        }
        .preview-module {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--surface-color);
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
        }
        .preview-module h4 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        .preview-lesson {
            margin-left: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-left: 2px solid var(--border-color);
            background: var(--bg-color);
            border-radius: 4px;
        }
        .preview-lesson h5 {
            margin: 0 0 0.5rem 0;
            font-size: 0.95rem;
        }
        .preview-content {
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        .preview-question {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        .action-buttons button {
            flex: 1;
            min-width: 120px;
        }
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-color);
            opacity: 0.7;
            font-style: italic;
        }
        .section-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .section-actions button {
            flex: 1;
            min-width: 140px;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            color: #856404;
        }
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            color: #155724;
        }
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            color: #721c24;
        }
    </style>
</head>
<body>
    <header>
        <h1>IC2026 E-Courses - Admin Panel</h1>
    </header>

    <main class="admin-container">
        <!-- Course Management section will be inserted here dynamically -->
        
        <div class="admin-card">
            <div class="builder-header">
                <h2>Course Builder</h2>
                <div class="action-buttons" style="margin: 0;">
                    <button id="new-course" class="button-secondary">New Course</button>
                    <button id="preview-course" class="button-secondary">Preview</button>
                    <button id="save-course" class="button">Save Course</button>
                </div>
            </div>
            <p>Create and edit courses with a visual interface.</p>
            
            <div class="builder-container">
                <div class="builder-sidebar">
                    <div class="form-section">
                        <h3>Course Details</h3>
                        <div class="form-group">
                            <label for="course-id">Course ID:</label>
                            <input type="text" id="course-id" placeholder="e.g., tour-guiding">
                            <small style="color: #666; font-size: 0.8rem;">Unique identifier for the course</small>
                        </div>
                        <div class="form-group">
                            <label for="course-title">Course Title:</label>
                            <input type="text" id="course-title" placeholder="e.g., Fundamentals of Tour Guiding">
                        </div>
                        <div class="form-group">
                            <label for="course-description">Description:</label>
                            <textarea id="course-description" placeholder="Brief description of the course"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="course-image">Image URL:</label>
                            <input type="text" id="course-image" placeholder="https://example.com/image.jpg">
                            <small style="color: #666; font-size: 0.8rem;">URL to course banner image</small>
                        </div>
                        <div class="form-group">
                            <label for="certificate-title">Certificate Title:</label>
                            <input type="text" id="certificate-title" placeholder="Title to display on certificate">
                        </div>
                        <div class="form-group">
                            <label for="certificate-message">Certificate Message:</label>
                            <textarea id="certificate-message" placeholder="Message to display on certificate"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Modules & Lessons</h3>
                        <div id="modules-container">
                            <!-- Modules will be added here dynamically -->
                        </div>
                        <div class="section-actions">
                            <button id="add-module" class="button-secondary">+ Add Module</button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Final Quiz</h3>
                        <div class="form-group">
                            <label for="quiz-title">Quiz Title:</label>
                            <input type="text" id="quiz-title" value="Final Assessment">
                        </div>
                        <div id="quiz-questions-container">
                            <!-- Quiz questions will be added here dynamically -->
                        </div>
                        <div class="section-actions">
                            <button id="add-quiz-question" class="button-secondary">+ Add Question</button>
                        </div>
                    </div>
                </div>
                
                <div class="builder-preview">
                    <h3>Course Preview</h3>
                    <div id="course-preview" class="preview-course">
                        <div class="empty-state">Create a course to see preview</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rest of admin panel remains the same -->
        <div class="admin-card">
            <h2>Data Export</h2>
            
            <div class="warning-box">
                <strong>⚠️ Important Notice:</strong> This admin panel only shows data from <em>this browser</em>. 
                To collect data from trainees, instruct them to use the "Export My Completion Data" button 
                after completing a course and have them send you the CSV files.
            </div>
            
            <p>Export completed course data from this browser:</p>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-records">0</div>
                    <div>Completed Courses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unique-users">0</div>
                    <div>Unique Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completion-rate">0%</div>
                    <div>Success Rate</div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="export-csv" class="button">Export Completed Courses (CSV)</button>
                <button id="export-json" class="button-secondary">Export as JSON</button>
                <button id="clear-data" class="button-secondary" style="background-color: var(--danger-color); color: white;">Clear Local Data</button>
            </div>
        </div>

        <div class="admin-card">
            <h2>Recent Completions</h2>
            <div id="recent-activity">
                <div class="no-data">No completion data available</div>
            </div>
        </div>

        <div class="admin-card">
            <h2>Course Management</h2>
            <p>Manage existing courses or create new ones.</p>
            <div class="action-buttons">
                <button id="manage-courses" class="button">Manage Courses</button>
                <a href="index.html" class="button-secondary">View Trainee Dashboard</a>
            </div>
            <div id="courses-list" style="margin-top: 1rem;">
                <!-- Existing courses will be listed here -->
            </div>
        </div>
    </main>

    <script>
        // Global variable to track current course being edited
        let currentEditingCourseId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Load course management first
            loadCourseManagement();
            
            // Initialize course builder
            initCourseBuilder();
            
            // Load the rest of the admin functionality
            loadAdminData();
        });

        function loadAdminData() {
            const quizResults = JSON.parse(localStorage.getItem('allQuizResults') || '[]');
            
            // Filter only passed courses
            const completedCourses = quizResults.filter(r => r.passed);
            
            // Update stats
            document.getElementById('total-records').textContent = completedCourses.length;
            
            const uniqueUsers = new Set(completedCourses.map(r => r.userCode)).size;
            document.getElementById('unique-users').textContent = uniqueUsers;
            
            const completionRate = quizResults.length > 0 ? 
                Math.round((completedCourses.length / quizResults.length) * 100) : 0;
            document.getElementById('completion-rate').textContent = completionRate + '%';
            
            // Update recent activity
            updateRecentActivity(completedCourses);
            
            // Export CSV
            document.getElementById('export-csv').addEventListener('click', function() {
                exportAllDataAsCSV(completedCourses);
            });
            
            // Export JSON
            document.getElementById('export-json').addEventListener('click', function() {
                exportAllDataAsJSON(completedCourses);
            });
            
            // Clear data
            document.getElementById('clear-data').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear ALL data from this browser? This cannot be undone.')) {
                    localStorage.removeItem('allQuizResults');
                    localStorage.removeItem('latestCompletion');
                    // Clear all progress keys
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('lmsProgress_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    alert('All local data cleared successfully.');
                    location.reload();
                }
            });
        }

        async function loadCourseManagement() {
            try {
                const coursesData = await loadCoursesData();
                
                // Create course management section
                const courseManagement = `
                    <div class="admin-card">
                        <h2>Available Courses</h2>
                        <p>Total Courses: ${coursesData.courses.length}</p>
                        <div class="action-buttons">
                            <button id="refresh-courses" class="button-secondary">Refresh Courses</button>
                        </div>
                        <div id="courses-list" style="margin-top: 1rem;">
                            ${coursesData.courses.map(course => `
                                <div class="course-item">
                                    <strong>${course.title}</strong> (${course.id})
                                    <div class="course-description">${course.description}</div>
                                    <div class="action-buttons" style="margin-top: 0.5rem;">
                                        <button class="button-secondary edit-course" data-course-id="${course.id}">Edit</button>
                                        <button class="button-secondary preview-course-btn" data-course-id="${course.id}">Preview</button>
                                        <button class="button-secondary delete-course" data-course-id="${course.id}" style="background-color: var(--danger-color); color: white;">Delete</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Insert at the beginning of the admin container
                document.querySelector('.admin-container').insertAdjacentHTML('afterbegin', courseManagement);
                
                // Add event listeners for the new buttons
                document.getElementById('refresh-courses').addEventListener('click', function() {
                    location.reload();
                });
                
                // Add event listeners for course management buttons
                document.querySelectorAll('.edit-course').forEach(button => {
                    button.addEventListener('click', function() {
                        const courseId = this.getAttribute('data-course-id');
                        loadCourseForEditing(courseId);
                    });
                });
                
                document.querySelectorAll('.preview-course-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const courseId = this.getAttribute('data-course-id');
                        previewCourse(courseId);
                    });
                });
                
                document.querySelectorAll('.delete-course').forEach(button => {
                    button.addEventListener('click', function() {
                        const courseId = this.getAttribute('data-course-id');
                        deleteCourse(courseId);
                    });
                });
                
            } catch (error) {
                console.error('Error loading course management:', error);
            }
        }

        // Course Builder Functions
        function initCourseBuilder() {
            // Add module button
            document.getElementById('add-module').addEventListener('click', addModule);
            
            // Add quiz question button
            document.getElementById('add-quiz-question').addEventListener('click', addQuizQuestion);
            
            // Save course button
            document.getElementById('save-course').addEventListener('click', saveCourse);
            
            // Preview course button
            document.getElementById('preview-course').addEventListener('click', previewCurrentCourse);
            
            // New course button
            document.getElementById('new-course').addEventListener('click', newCourse);
            
            // Manage courses button
            document.getElementById('manage-courses').addEventListener('click', function() {
                document.querySelector('.admin-card:first-child').scrollIntoView({ behavior: 'smooth' });
            });
            
            // Initialize with empty state
            newCourse();
        }
        
        function addModule() {
            const moduleId = 'm' + (document.querySelectorAll('.module-item').length + 1);
            const modulesContainer = document.getElementById('modules-container');
            
            const moduleHTML = `
                <div class="module-item" data-module-id="${moduleId}">
                    <div class="module-header">
                        <div class="form-group">
                            <input type="text" class="module-title" placeholder="Module Title" value="New Module">
                        </div>
                        <div class="content-actions">
                            <button class="add-lesson" title="Add Lesson">+ Lesson</button>
                            <button class="delete-module delete" title="Delete Module">Delete</button>
                        </div>
                    </div>
                    <div class="lessons-container" id="lessons-${moduleId}">
                        <!-- Lessons will be added here -->
                    </div>
                </div>
            `;
            
            modulesContainer.insertAdjacentHTML('beforeend', moduleHTML);
            
            // Add event listeners for the new module
            const newModule = modulesContainer.lastElementChild;
            newModule.querySelector('.add-lesson').addEventListener('click', function() {
                addLesson(moduleId);
            });
            
            newModule.querySelector('.delete-module').addEventListener('click', function() {
                this.closest('.module-item').remove();
            });
            
            // Add first lesson to the new module
            addLesson(moduleId);
        }
        
        function addLesson(moduleId) {
            const lessonId = moduleId + 'l' + (document.querySelectorAll(`#lessons-${moduleId} .lesson-item`).length + 1);
            const lessonsContainer = document.getElementById(`lessons-${moduleId}`);
            
            const lessonHTML = `
                <div class="lesson-item" data-lesson-id="${lessonId}">
                    <div class="lesson-header">
                        <div class="form-group">
                            <input type="text" class="lesson-title" placeholder="Lesson Title" value="New Lesson">
                        </div>
                        <div class="content-actions">
                            <button class="add-content" title="Add Content">+ Content</button>
                            <button class="delete-lesson delete" title="Delete Lesson">Delete</button>
                        </div>
                    </div>
                    <div class="lesson-content" id="content-${lessonId}">
                        <!-- Content items will be added here -->
                    </div>
                </div>
            `;
            
            lessonsContainer.insertAdjacentHTML('beforeend', lessonHTML);
            
            // Add event listeners for the new lesson
            const newLesson = lessonsContainer.lastElementChild;
            newLesson.querySelector('.add-content').addEventListener('click', function() {
                addContentItem(lessonId);
            });
            
            newLesson.querySelector('.delete-lesson').addEventListener('click', function() {
                this.closest('.lesson-item').remove();
            });
            
            // Add first content item to the new lesson
            addContentItem(lessonId);
        }
        
        function addContentItem(lessonId) {
            const contentId = 'content-' + Date.now();
            const contentContainer = document.getElementById(`content-${lessonId}`);
            
            const contentHTML = `
                <div class="content-item" data-content-id="${contentId}">
                    <div class="content-header">
                        <select class="content-type">
                            <option value="text">Text</option>
                            <option value="list">List</option>
                            <option value="video">Video</option>
                            <option value="tip">Tip</option>
                            <option value="actions">Actions</option>
                        </select>
                        <div class="content-actions">
                            <button class="move-up" title="Move Up">↑</button>
                            <button class="move-down" title="Move Down">↓</button>
                            <button class="delete-content delete" title="Delete Content">Delete</button>
                        </div>
                    </div>
                    <div class="content-data">
                        <div class="form-group">
                            <textarea class="content-text" placeholder="Enter text content"></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            contentContainer.insertAdjacentHTML('beforeend', contentHTML);
            
            // Add event listeners for the new content item
            const newContent = contentContainer.lastElementChild;
            const contentTypeSelect = newContent.querySelector('.content-type');
            
            contentTypeSelect.addEventListener('change', function() {
                updateContentUI(contentId, this.value);
            });
            
            newContent.querySelector('.delete-content').addEventListener('click', function() {
                this.closest('.content-item').remove();
            });
            
            newContent.querySelector('.move-up').addEventListener('click', function() {
                const item = this.closest('.content-item');
                const prev = item.previousElementSibling;
                if (prev) {
                    contentContainer.insertBefore(item, prev);
                }
            });
            
            newContent.querySelector('.move-down').addEventListener('click', function() {
                const item = this.closest('.content-item');
                const next = item.nextElementSibling;
                if (next) {
                    contentContainer.insertBefore(next, item);
                }
            });
        }
        
        function updateContentUI(contentId, type) {
            const contentItem = document.querySelector(`[data-content-id="${contentId}"]`);
            const contentData = contentItem.querySelector('.content-data');
            
            let html = '';
            
            switch(type) {
                case 'text':
                    html = `
                        <div class="form-group">
                            <textarea class="content-text" placeholder="Enter text content"></textarea>
                        </div>
                    `;
                    break;
                case 'list':
                    html = `
                        <div class="form-group">
                            <textarea class="content-list" placeholder="Enter list items, one per line"></textarea>
                        </div>
                    `;
                    break;
                case 'video':
                    html = `
                        <div class="form-group">
                            <input type="text" class="content-video" placeholder="YouTube embed URL">
                        </div>
                    `;
                    break;
                case 'tip':
                    html = `
                        <div class="form-group">
                            <label>Summary:</label>
                            <input type="text" class="content-tip-summary" placeholder="Tip summary">
                        </div>
                        <div class="form-group">
                            <label>Details:</label>
                            <textarea class="content-tip-details" placeholder="Tip details (HTML allowed)"></textarea>
                        </div>
                    `;
                    break;
                case 'actions':
                    html = `
                        <div class="form-group">
                            <label>Download URL:</label>
                            <input type="text" class="content-action-url" placeholder="File URL">
                        </div>
                        <div class="form-group">
                            <label>Button Text:</label>
                            <input type="text" class="content-action-text" placeholder="Download text">
                        </div>
                    `;
                    break;
            }
            
            contentData.innerHTML = html;
        }
        
        function addQuizQuestion() {
            const questionId = 'q' + (document.querySelectorAll('.quiz-question-item').length + 1);
            const questionsContainer = document.getElementById('quiz-questions-container');
            
            const questionHTML = `
                <div class="quiz-question-item" data-question-id="${questionId}">
                    <div class="content-header">
                        <select class="question-type">
                            <option value="multiple-choice">Multiple Choice</option>
                            <option value="essay">Essay</option>
                        </select>
                        <div class="content-actions">
                            <button class="delete-question delete" title="Delete Question">Delete</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <textarea class="question-text" placeholder="Question text"></textarea>
                    </div>
                    <div class="question-options" id="options-${questionId}">
                        <div class="option-row">
                            <input type="radio" name="correct-${questionId}" value="a" checked>
                            <input type="text" class="option-a" placeholder="Option A">
                            <button class="delete-option delete">×</button>
                        </div>
                        <div class="option-row">
                            <input type="radio" name="correct-${questionId}" value="b">
                            <input type="text" class="option-b" placeholder="Option B">
                            <button class="delete-option delete">×</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <textarea class="question-hint" placeholder="Hint (optional)"></textarea>
                    </div>
                    <div class="form-group question-suggestion" style="display: none;">
                        <textarea class="question-suggestion-text" placeholder="Suggested answer for essay questions"></textarea>
                    </div>
                    <button class="button-secondary add-option">+ Add Option</button>
                </div>
            `;
            
            questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
            
            // Add event listeners for the new question
            const newQuestion = questionsContainer.lastElementChild;
            const questionTypeSelect = newQuestion.querySelector('.question-type');
            
            questionTypeSelect.addEventListener('change', function() {
                const isEssay = this.value === 'essay';
                newQuestion.querySelector('.question-options').style.display = isEssay ? 'none' : 'block';
                newQuestion.querySelector('.question-suggestion').style.display = isEssay ? 'block' : 'none';
                newQuestion.querySelector('.add-option').style.display = isEssay ? 'none' : 'block';
            });
            
            newQuestion.querySelector('.delete-question').addEventListener('click', function() {
                this.closest('.quiz-question-item').remove();
            });
            
            newQuestion.querySelector('.add-option').addEventListener('click', function() {
                const optionsContainer = newQuestion.querySelector('.question-options');
                const optionCount = optionsContainer.children.length;
                const nextOption = String.fromCharCode(97 + optionCount); // a, b, c, etc.
                
                const optionHTML = `
                    <div class="option-row">
                        <input type="radio" name="correct-${questionId}" value="${nextOption}">
                        <input type="text" class="option-${nextOption}" placeholder="Option ${nextOption.toUpperCase()}">
                        <button class="delete-option delete">×</button>
                    </div>
                `;
                
                optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
                
                // Add event listener for the delete button
                optionsContainer.lastElementChild.querySelector('.delete-option').addEventListener('click', function() {
                    this.closest('.option-row').remove();
                });
            });

            // Add event listeners for existing delete buttons
            newQuestion.querySelectorAll('.delete-option').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.option-row').remove();
                });
            });
        }
        
        async function saveCourse() {
            try {
                // Collect course data from form
                const courseData = {
                    id: document.getElementById('course-id').value.trim(),
                    title: document.getElementById('course-title').value.trim(),
                    description: document.getElementById('course-description').value.trim(),
                    image: document.getElementById('course-image').value.trim(),
                    certificateTitle: document.getElementById('certificate-title').value.trim(),
                    certificateMessage: document.getElementById('certificate-message').value.trim(),
                    dataFile: `data/course-${document.getElementById('course-id').value.trim()}.json`
                };
                
                // Validate required fields
                if (!courseData.id) {
                    alert('Course ID is required.');
                    return;
                }
                if (!courseData.title) {
                    alert('Course Title is required.');
                    return;
                }
                
                // Collect modules and lessons
                const modules = [];
                document.querySelectorAll('.module-item').forEach((moduleEl, moduleIndex) => {
                    const module = {
                        moduleTitle: moduleEl.querySelector('.module-title').value.trim() || `Module ${moduleIndex + 1}`,
                        lessons: []
                    };
                    
                    moduleEl.querySelectorAll('.lesson-item').forEach((lessonEl, lessonIndex) => {
                        const lesson = {
                            id: `m${moduleIndex + 1}l${lessonIndex + 1}`,
                            title: lessonEl.querySelector('.lesson-title').value.trim() || `Lesson ${lessonIndex + 1}`,
                            content: []
                        };
                        
                        lessonEl.querySelectorAll('.content-item').forEach(contentEl => {
                            const type = contentEl.querySelector('.content-type').value;
                            let data = '';
                            
                            switch(type) {
                                case 'text':
                                    data = contentEl.querySelector('.content-text').value.trim();
                                    break;
                                case 'list':
                                    data = contentEl.querySelector('.content-list').value.split('\n')
                                        .filter(item => item.trim())
                                        .map(item => item.trim());
                                    break;
                                case 'video':
                                    data = contentEl.querySelector('.content-video').value.trim();
                                    break;
                                case 'tip':
                                    data = {
                                        summary: contentEl.querySelector('.content-tip-summary').value.trim(),
                                        details: contentEl.querySelector('.content-tip-details').value.trim()
                                    };
                                    break;
                                case 'actions':
                                    data = {
                                        download: {
                                            url: contentEl.querySelector('.content-action-url').value.trim(),
                                            text: contentEl.querySelector('.content-action-text').value.trim()
                                        }
                                    };
                                    break;
                            }
                            
                            if (data && (typeof data === 'string' ? data.length > 0 : true)) {
                                lesson.content.push({
                                    type: type,
                                    data: data
                                });
                            }
                        });
                        
                        if (lesson.content.length > 0) {
                            module.lessons.push(lesson);
                        }
                    });
                    
                    if (module.lessons.length > 0) {
                        modules.push(module);
                    }
                });
                
                // Collect quiz questions
                const quiz = {
                    id: 'quiz',
                    title: document.getElementById('quiz-title').value.trim() || 'Final Assessment',
                    questions: []
                };
                
                document.querySelectorAll('.quiz-question-item').forEach((questionEl, index) => {
                    const type = questionEl.querySelector('.question-type').value;
                    const questionText = questionEl.querySelector('.question-text').value.trim();
                    
                    if (!questionText) return; // Skip empty questions
                    
                    const question = {
                        id: `q${index + 1}`,
                        text: questionText,
                        type: type,
                        hint: questionEl.querySelector('.question-hint').value.trim()
                    };
                    
                    if (type === 'multiple-choice') {
                        question.options = {};
                        let hasOptions = false;
                        
                        questionEl.querySelectorAll('.option-row').forEach(optionEl => {
                            const value = optionEl.querySelector('input[type="radio"]').value;
                            const text = optionEl.querySelector('input[type="text"]').value.trim();
                            
                            if (text) {
                                question.options[value] = text;
                                hasOptions = true;
                                
                                if (optionEl.querySelector('input[type="radio"]').checked) {
                                    question.correct = value;
                                }
                            }
                        });
                        
                        if (!hasOptions || !question.correct) return; // Skip invalid multiple choice questions
                    } else if (type === 'essay') {
                        question.suggestion = questionEl.querySelector('.question-suggestion-text').value.trim();
                    }
                    
                    quiz.questions.push(question);
                });
                
                // Create the course JSON structure
                const courseJSON = {
                    courseTitle: courseData.title,
                    modules: modules,
                    quiz: quiz
                };
                
                // Update courses.json
                const success = await updateCoursesJSON(courseData, courseJSON);
                
                if (success) {
                    showMessage('Course saved successfully!', 'success');
                    // Reload the course management section to show the updated course
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showMessage('Error saving course. Check console for details.', 'error');
                }
            } catch (error) {
                console.error('Error saving course:', error);
                showMessage('Error saving course: ' + error.message, 'error');
            }
        }
        
        function showMessage(message, type) {
            // Remove any existing messages
            const existingMessage = document.querySelector('.success-message, .error-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            // Insert after the course builder header
            const builderCard = document.querySelector('.admin-card:nth-child(2)');
            const header = builderCard.querySelector('.builder-header');
            header.parentNode.insertBefore(messageDiv, header.nextSibling);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
        
        async function loadCoursesData() {
            try {
                // Try to load from server first
                const response = await fetch('data/courses.json');
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.log('Could not load courses.json from server, trying localStorage');
            }
            
            // Fallback to localStorage
            const storedData = localStorage.getItem('courses-data');
            if (storedData) {
                return JSON.parse(storedData);
            }
            
            // Return empty structure if nothing found
            return { courses: [] };
        }
        
        async function updateCoursesJSON(courseData, courseJSON) {
            try {
                // Load existing courses
                const coursesData = await loadCoursesData();
                
                // Check if course already exists
                const existingIndex = coursesData.courses.findIndex(c => c.id === courseData.id);
                
                if (existingIndex >= 0) {
                    // Update existing course
                    coursesData.courses[existingIndex] = courseData;
                } else {
                    // Add new course
                    coursesData.courses.push(courseData);
                }
                
                // Save course content to localStorage
                localStorage.setItem(`course-${courseData.id}`, JSON.stringify(courseJSON));
                localStorage.setItem('courses-data', JSON.stringify(coursesData));
                
                console.log('Course saved to localStorage:', courseData);
                console.log('Course content:', courseJSON);
                
                return true;
            } catch (error) {
                console.error('Error saving course:', error);
                return false;
            }
        }
        
        async function loadCourseForEditing(courseId) {
            try {
                // Load course data
                const coursesData = await loadCoursesData();
                const courseData = coursesData.courses.find(c => c.id === courseId);
                
                if (!courseData) {
                    alert('Course not found: ' + courseId);
                    return;
                }
                
                // Load course content
                let courseJSON;
                try {
                    const response = await fetch(courseData.dataFile);
                    if (response.ok) {
                        courseJSON = await response.json();
                    } else {
                        throw new Error('Could not fetch course content');
                    }
                } catch (error) {
                    // Fallback to localStorage
                    const storedCourse = localStorage.getItem(`course-${courseId}`);
                    if (storedCourse) {
                        courseJSON = JSON.parse(storedCourse);
                    } else {
                        alert('Could not load course content for: ' + courseId);
                        return;
                    }
                }
                
                // Set current editing course
                currentEditingCourseId = courseId;
                
                // Populate form with course data
                document.getElementById('course-id').value = courseData.id || '';
                document.getElementById('course-title').value = courseData.title || '';
                document.getElementById('course-description').value = courseData.description || '';
                document.getElementById('course-image').value = courseData.image || '';
                document.getElementById('certificate-title').value = courseData.certificateTitle || '';
                document.getElementById('certificate-message').value = courseData.certificateMessage || '';
                
                // Clear existing modules and lessons
                document.getElementById('modules-container').innerHTML = '';
                document.getElementById('quiz-questions-container').innerHTML = '';
                
                // Add modules and lessons from course JSON
                if (courseJSON.modules && courseJSON.modules.length > 0) {
                    courseJSON.modules.forEach((module, moduleIndex) => {
                        addModule();
                        const modules = document.querySelectorAll('.module-item');
                        const currentModule = modules[modules.length - 1];
                        
                        // Set module title
                        const moduleTitleInput = currentModule.querySelector('.module-title');
                        if (moduleTitleInput) {
                            moduleTitleInput.value = module.moduleTitle || `Module ${moduleIndex + 1}`;
                        }
                        
                        // Clear existing lessons
                        const lessonsContainer = currentModule.querySelector('.lessons-container');
                        if (lessonsContainer) {
                            lessonsContainer.innerHTML = '';
                        }
                        
                        // Add lessons
                        if (module.lessons && module.lessons.length > 0) {
                            module.lessons.forEach((lesson, lessonIndex) => {
                                addLesson(currentModule.getAttribute('data-module-id'));
                                const lessons = lessonsContainer.querySelectorAll('.lesson-item');
                                const currentLesson = lessons[lessons.length - 1];
                                
                                // Set lesson title and ID
                                const lessonTitleInput = currentLesson.querySelector('.lesson-title');
                                if (lessonTitleInput) {
                                    lessonTitleInput.value = lesson.title || `Lesson ${lessonIndex + 1}`;
                                }
                                currentLesson.setAttribute('data-lesson-id', lesson.id || `m${moduleIndex + 1}l${lessonIndex + 1}`);
                                
                                // Clear existing content
                                const contentContainer = currentLesson.querySelector('.lesson-content');
                                if (contentContainer) {
                                    contentContainer.innerHTML = '';
                                }
                                
                                // Add content items
                                if (lesson.content && lesson.content.length > 0) {
                                    lesson.content.forEach(content => {
                                        addContentItem(currentLesson.getAttribute('data-lesson-id'));
                                        const contentItems = contentContainer.querySelectorAll('.content-item');
                                        const currentContent = contentItems[contentItems.length - 1];
                                        
                                        // Set content type and data
                                        const contentTypeSelect = currentContent.querySelector('.content-type');
                                        if (contentTypeSelect) {
                                            contentTypeSelect.value = content.type;
                                            updateContentUI(currentContent.getAttribute('data-content-id'), content.type);
                                            
                                            // Set content data based on type
                                            switch(content.type) {
                                                case 'text':
                                                    const textArea = currentContent.querySelector('.content-text');
                                                    if (textArea) textArea.value = content.data || '';
                                                    break;
                                                case 'list':
                                                    const listArea = currentContent.querySelector('.content-list');
                                                    if (listArea) listArea.value = Array.isArray(content.data) ? 
                                                        content.data.join('\n') : (content.data || '');
                                                    break;
                                                case 'video':
                                                    const videoInput = currentContent.querySelector('.content-video');
                                                    if (videoInput) videoInput.value = content.data || '';
                                                    break;
                                                case 'tip':
                                                    const summaryInput = currentContent.querySelector('.content-tip-summary');
                                                    const detailsArea = currentContent.querySelector('.content-tip-details');
                                                    if (summaryInput) summaryInput.value = content.data.summary || '';
                                                    if (detailsArea) detailsArea.value = content.data.details || '';
                                                    break;
                                                case 'actions':
                                                    const urlInput = currentContent.querySelector('.content-action-url');
                                                    const textInput = currentContent.querySelector('.content-action-text');
                                                    if (urlInput) urlInput.value = content.data.download?.url || '';
                                                    if (textInput) textInput.value = content.data.download?.text || '';
                                                    break;
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });
                } else {
                    // Add a default module if none exist
                    addModule();
                }
                
                // Add quiz questions
                document.getElementById('quiz-title').value = courseJSON.quiz?.title || 'Final Assessment';
                
                if (courseJSON.quiz && courseJSON.quiz.questions && courseJSON.quiz.questions.length > 0) {
                    courseJSON.quiz.questions.forEach((question, index) => {
                        addQuizQuestion();
                        const questionsContainer = document.getElementById('quiz-questions-container');
                        const lastQuestion = questionsContainer.lastElementChild;
                        
                        // Set question data
                        const typeSelect = lastQuestion.querySelector('.question-type');
                        const textArea = lastQuestion.querySelector('.question-text');
                        const hintArea = lastQuestion.querySelector('.question-hint');
                        
                        if (typeSelect) typeSelect.value = question.type || 'multiple-choice';
                        if (textArea) textArea.value = question.text || '';
                        if (hintArea) hintArea.value = question.hint || '';
                        
                        // Trigger change event to update UI
                        if (typeSelect) {
                            typeSelect.dispatchEvent(new Event('change'));
                        }
                        
                        if (question.type === 'multiple-choice') {
                            // Set options
                            if (question.options) {
                                Object.entries(question.options).forEach(([key, value], optionIndex) => {
                                    if (optionIndex > 1) {
                                        // Add additional options if needed
                                        lastQuestion.querySelector('.add-option').click();
                                    }
                                    
                                    const optionInput = lastQuestion.querySelector(`.option-${key}`);
                                    if (optionInput) {
                                        optionInput.value = value || '';
                                    }
                                    
                                    // Set correct answer
                                    if (question.correct === key) {
                                        const radioInput = lastQuestion.querySelector(`input[value="${key}"]`);
                                        if (radioInput) {
                                            radioInput.checked = true;
                                        }
                                    }
                                });
                            }
                        } else if (question.type === 'essay') {
                            const suggestionArea = lastQuestion.querySelector('.question-suggestion-text');
                            if (suggestionArea) {
                                suggestionArea.value = question.suggestion || '';
                            }
                        }
                    });
                } else {
                    // Add a default quiz question if none exist
                    addQuizQuestion();
                }
                
                // Scroll to course builder
                document.querySelector('.admin-card:nth-child(2)').scrollIntoView({ behavior: 'smooth' });
                
                showMessage(`Now editing: ${courseData.title}`, 'success');
                
            } catch (error) {
                console.error('Error loading course for editing:', error);
                showMessage('Error loading course: ' + error.message, 'error');
            }
        }
        
        function previewCurrentCourse() {
            const previewContainer = document.getElementById('course-preview');
            const courseTitle = document.getElementById('course-title').value || 'Untitled Course';
            const courseDescription = document.getElementById('course-description').value || 'No description';
            
            let previewHTML = `
                <h3 style="margin-top: 0;">${courseTitle}</h3>
                <p>${courseDescription}</p>
            `;
            
            // Add modules preview
            const modules = document.querySelectorAll('.module-item');
            if (modules.length === 0) {
                previewHTML += '<div class="empty-state">No modules added yet</div>';
            } else {
                modules.forEach((moduleEl, moduleIndex) => {
                    const moduleTitle = moduleEl.querySelector('.module-title').value || `Module ${moduleIndex + 1}`;
                    
                    previewHTML += `
                        <div class="preview-module">
                            <h4>${moduleTitle}</h4>
                    `;
                    
                    const lessons = moduleEl.querySelectorAll('.lesson-item');
                    if (lessons.length === 0) {
                        previewHTML += '<div class="empty-state">No lessons in this module</div>';
                    } else {
                        lessons.forEach((lessonEl, lessonIndex) => {
                            const lessonTitle = lessonEl.querySelector('.lesson-title').value || `Lesson ${lessonIndex + 1}`;
                            
                            previewHTML += `
                                <div class="preview-lesson">
                                    <h5>${lessonTitle}</h5>
                            `;
                            
                            const contentItems = lessonEl.querySelectorAll('.content-item');
                            if (contentItems.length === 0) {
                                previewHTML += '<div class="empty-state">No content in this lesson</div>';
                            } else {
                                contentItems.forEach(contentEl => {
                                    const type = contentEl.querySelector('.content-type').value;
                                    let contentHTML = '';
                                    
                                    switch(type) {
                                        case 'text':
                                            const text = contentEl.querySelector('.content-text').value;
                                            contentHTML = text ? `<div class="preview-content">${text}</div>` : '<div class="empty-state">No text content</div>';
                                            break;
                                        case 'list':
                                            const listItems = contentEl.querySelector('.content-list').value.split('\n')
                                                .filter(item => item.trim())
                                                .map(item => `<li>${item}</li>`)
                                                .join('');
                                            contentHTML = listItems ? `<ul class="preview-content">${listItems}</ul>` : '<div class="empty-state">No list items</div>';
                                            break;
                                        case 'video':
                                            const videoUrl = contentEl.querySelector('.content-video').value;
                                            contentHTML = videoUrl ? 
                                                `<div class="preview-content">🎥 Video: ${videoUrl}</div>` : 
                                                '<div class="empty-state">No video URL</div>';
                                            break;
                                        case 'tip':
                                            const summary = contentEl.querySelector('.content-tip-summary').value;
                                            contentHTML = summary ? 
                                                `<div class="preview-content">💡 Tip: ${summary}</div>` : 
                                                '<div class="empty-state">No tip content</div>';
                                            break;
                                        case 'actions':
                                            const actionText = contentEl.querySelector('.content-action-text').value;
                                            contentHTML = actionText ? 
                                                `<div class="preview-content">📥 Action: ${actionText}</div>` : 
                                                '<div class="empty-state">No action defined</div>';
                                            break;
                                    }
                                    
                                    previewHTML += contentHTML;
                                });
                            }
                            
                            previewHTML += `</div>`;
                        });
                    }
                    
                    previewHTML += `</div>`;
                });
            }
            
            // Add quiz preview
            const quizTitle = document.getElementById('quiz-title').value || 'Final Assessment';
            previewHTML += `
                <div class="preview-module">
                    <h4>${quizTitle}</h4>
            `;
            
            const quizQuestions = document.querySelectorAll('.quiz-question-item');
            if (quizQuestions.length === 0) {
                previewHTML += '<div class="empty-state">No quiz questions added</div>';
            } else {
                quizQuestions.forEach((questionEl, index) => {
                    const questionText = questionEl.querySelector('.question-text').value || 'No question text';
                    const type = questionEl.querySelector('.question-type').value;
                    
                    previewHTML += `
                        <div class="preview-question">
                            <p><strong>Question ${index + 1}:</strong> ${questionText}</p>
                            <p><em>Type: ${type}</em></p>
                    `;
                    
                    if (type === 'multiple-choice') {
                        const options = questionEl.querySelectorAll('.option-row');
                        if (options.length > 0) {
                            previewHTML += '<p><strong>Options:</strong></p><ul>';
                            
                            options.forEach(optionEl => {
                                const value = optionEl.querySelector('input[type="radio"]').value;
                                const text = optionEl.querySelector('input[type="text"]').value || 'No option text';
                                const isCorrect = optionEl.querySelector('input[type="radio"]').checked;
                                
                                previewHTML += `<li>${value.toUpperCase()}: ${text} ${isCorrect ? '✅ (Correct)' : ''}</li>`;
                            });
                            
                            previewHTML += '</ul>';
                        }
                    }
                    
                    previewHTML += `</div>`;
                });
            }
            
            previewHTML += `</div>`;
            
            previewContainer.innerHTML = previewHTML;
        }
        
        function newCourse() {
            // Clear all form fields
            document.getElementById('course-id').value = '';
            document.getElementById('course-title').value = '';
            document.getElementById('course-description').value = '';
            document.getElementById('course-image').value = '';
            document.getElementById('certificate-title').value = '';
            document.getElementById('certificate-message').value = '';
            
            // Clear modules and lessons
            document.getElementById('modules-container').innerHTML = '';
            document.getElementById('quiz-questions-container').innerHTML = '';
            
            // Reset current editing course
            currentEditingCourseId = null;
            
            // Reset preview
            document.getElementById('course-preview').innerHTML = '<div class="empty-state">Create a course to see preview</div>';
            
            // Add a default module
            addModule();
            
            // Add a default quiz question
            addQuizQuestion();
            
            showMessage('Started new course', 'success');
        }
        
        async function deleteCourse(courseId) {
            if (confirm(`Are you sure you want to delete course "${courseId}"? This action cannot be undone.`)) {
                try {
                    const coursesData = await loadCoursesData();
                    const updatedCourses = coursesData.courses.filter(c => c.id !== courseId);
                    
                    // Update courses data
                    coursesData.courses = updatedCourses;
                    localStorage.setItem('courses-data', JSON.stringify(coursesData));
                    
                    // Remove course content
                    localStorage.removeItem(`course-${courseId}`);
                    
                    showMessage(`Course "${courseId}" deleted successfully!`, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } catch (error) {
                    console.error('Error deleting course:', error);
                    showMessage('Error deleting course: ' + error.message, 'error');
                }
            }
        }

        function previewCourse(courseId) {
            alert(`Preview functionality for course "${courseId}" would open in a new window/tab.`);
            // In a full implementation, this would open course.html with the specified course
        }

        // Existing functions for data export
        function updateRecentActivity(completedCourses) {
            const recentActivity = document.getElementById('recent-activity');
            
            if (completedCourses.length === 0) {
                recentActivity.innerHTML = '<div class="no-data">No completion data available</div>';
                return;
            }
            
            // Sort by completion date (newest first)
            const sorted = [...completedCourses].sort((a, b) => 
                new Date(b.completedAt || b.timestamp) - new Date(a.completedAt || a.timestamp)
            );
            
            // Show only the 10 most recent
            const recent = sorted.slice(0, 10);
            
            let html = '<table class="data-table"><thead><tr><th>User</th><th>Course</th><th>Date</th><th>Score</th></tr></thead><tbody>';
            
            recent.forEach(result => {
                const date = new Date(result.completedAt || result.timestamp).toLocaleDateString();
                html += `<tr>
                    <td>${result.userCode || 'Unknown'}</td>
                    <td>${result.courseId || 'Unknown'}</td>
                    <td>${date}</td>
                    <td>${result.score || 'N/A'}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            recentActivity.innerHTML = html;
        }

        function exportAllDataAsCSV(completedCourses) {
            if (completedCourses.length === 0) {
                alert('No completion data to export.');
                return;
            }
            
            // Create CSV header
            let csv = 'User Code,Course ID,Completed At,Score,Passed\n';
            
            // Add data rows
            completedCourses.forEach(result => {
                const date = new Date(result.completedAt || result.timestamp).toISOString();
                csv += `"${result.userCode || ''}","${result.courseId || ''}","${date}",${result.score || ''},${result.passed}\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lms-completions-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportAllDataAsJSON(completedCourses) {
            if (completedCourses.length === 0) {
                alert('No completion data to export.');
                return;
            }
            
            // Create JSON data
            const exportData = {
                exportedAt: new Date().toISOString(),
                totalRecords: completedCourses.length,
                completions: completedCourses
            };
            
            // Create download link
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lms-completions-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>